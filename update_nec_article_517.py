import sys
import os

# Import directly from app
from app import create_app, db
from models import NECArticle

def update_nec_article():
    """Update or add NEC article 517 to the database."""
    # Article data
    article_data = {
        "article_number": "517",
        "title": "Health Care Facilities",
        "summary": "Article 517 covers the electrical requirements for health care facilities, including hospitals, nursing homes, and medical and dental offices. It addresses patient care areas, essential electrical systems, isolated power systems, and special requirements to ensure patient safety and continuity of care.",
        "content": "<h3>Scope and Purpose</h3><p>Article 517 covers the electrical requirements for health care facilities, where patients receive medical care. The unique electrical safety needs in these environments stem from a few critical concerns:</p><ul><li>Patients may be particularly vulnerable to electrical shock due to compromised skin barriers (IVs, catheters) or weakened physical condition</li><li>Medical procedures might require electrical equipment placed in close proximity to patients</li><li>Continuity of power is essential for life-supporting equipment and critical care</li></ul><p>The article provides specific requirements for various medical settings, from hospitals and nursing homes to outpatient facilities, dental offices, and even limited care facilities such as assisted living centers.</p><h3>Classification of Patient Care Spaces</h3><p><strong>Patient Care Space Categories (517.2):</strong> The NEC classifies patient care spaces into three categories, each with increasingly stringent electrical requirements:</p><p><strong>1. Basic Care Spaces:</strong> Areas where patients will self-administer care or be treated by medical staff, but where patients are not typically connected to electrical medical equipment. Examples include examination rooms in clinics, some outpatient facilities, and dental offices without general anesthesia.</p><p><strong>2. General Care Spaces:</strong> Areas where patients are intended to have contact with electrical appliances, and might be connected to some electrical medical equipment. Examples include patient rooms in hospitals, dialysis areas, and certain procedure rooms. These spaces require additional safety measures, such as redundant grounding paths.</p><p><strong>3. Critical Care Spaces:</strong> Areas where patients are subjected to invasive procedures and connected to multiple electrical devices for life support, monitoring, or treatment. Examples include operating rooms, intensive care units (ICUs), and emergency rooms. These spaces require the highest level of electrical safety, often including isolated power systems and special grounding requirements.</p><p>These classifications determine the extent of special electrical requirements needed in each area, ensuring appropriate safety measures without unnecessary expense in lower-risk areas.</p><h3>Wiring and Protection</h3><p><strong>Branch Circuit Requirements (517.18-517.19):</strong> For general care spaces, a minimum of two branch circuits must supply receptacles at each patient bed location, with at least one circuit from the critical branch of the emergency system. For critical care spaces, at least one branch circuit from the normal system and one from the critical branch of the emergency system are required, along with additional redundancy measures.</p><p><strong>Ground-Fault Circuit Interrupter (GFCI) Protection (517.21):</strong> GFCI protection is required for all receptacles in bathrooms, locations within 6 feet of sinks, and wet procedure areas. However, GFCI protection is not typically provided in critical care spaces where interruption of power could endanger patients (instead, isolated power systems are often used).</p><p><strong>Special Grounding Requirements (517.13):</strong> In patient care spaces, an additional level of grounding protection is required. This is achieved through:</p><ul><li>A redundant equipment grounding conductor run with the circuit conductors</li><li>Special receptacles that ensure a reliable connection to the equipment grounding conductor</li></ul><p>This redundant grounding significantly reduces the risk of electrical shock in patient care environments, where even small electrical leakage currents can be dangerous.</p><h3>Essential Electrical Systems</h3><p><strong>Definition and Purpose (517.30):</strong> The essential electrical system (EES) provides alternate power when normal power is interrupted. It ensures that critical medical equipment, lighting, and systems continue to operate during a power outage. The EES typically consists of:</p><ul><li>An alternate power source (typically a generator)</li><li>Transfer switches</li><li>Distribution panels and circuits for critical loads</li></ul><p><strong>EES Components (517.30-517.35):</strong> For hospitals, the essential electrical system is divided into three branches:</p><p><strong>1. Life Safety Branch:</strong> Supplies power for egress lighting, exit signs, alarm systems, and other functions essential for safe evacuation. This branch must automatically transfer to the alternate power source within 10 seconds of a normal power interruption.</p><p><strong>2. Critical Branch:</strong> Supplies power to critical patient care areas and certain essential medical equipment. Like the life safety branch, it must transfer to alternate power within 10 seconds.</p><p><strong>3. Equipment Branch:</strong> Supplies major electrical equipment necessary for patient care, such as HVAC systems, elevator controls, and certain diagnostic equipment. This branch can have an automatic or manual transfer to alternate power, with delayed automatic connection allowed if necessary to prevent generator overload.</p><p>Other health care facilities such as nursing homes may have simplified versions of the essential electrical system, based on the types of care provided and the risk to patients during a power outage.</p><h3>Isolated Power Systems</h3><p><strong>Purpose and Application (517.160):</strong> In wet locations where flammable anesthetics might be used or where patients might be particularly vulnerable to microshock (e.g., during cardiac surgery), isolated power systems may be required. These systems:</p><ul><li>Isolate the power distribution system from ground using an isolation transformer</li><li>Monitor leakage current continuously</li><li>Alert staff to the first ground fault without disconnecting power</li></ul><p>This allows continued operation during a single ground fault, while providing an alert that maintenance is needed. The system prevents hazardous current from flowing through a patient to ground, significantly reducing shock risk.</p><p><strong>Line Isolation Monitor (517.160(B)):</strong> Each isolated power system must include a line isolation monitor that continuously monitors the impedance between each line and ground. If the system develops too much leakage to ground, the monitor will trigger an audible and visual alarm, alerting staff to the problem without interrupting power.</p><h3>Other Special Requirements</h3><p><strong>Psychiatric Patient Areas (517.160(C)):</strong> In areas where psychiatric patients might be housed, special consideration must be given to preventing patient self-harm. This includes tamper-resistant or special-purpose receptacles, secure lighting fixtures, and other measures to limit patient access to electrical components that could be used for self-harm.</p><p><strong>X-Ray Installations (517.71-517.78):</strong> X-ray equipment must have specific disconnecting means, be connected to appropriate branch circuits, and include protective measures commensurate with the equipment's capacity. Additional provisions address mobile X-ray equipment and connections within patient care spaces.</p><p><strong>Communications, Signaling, and Data Systems (517.80-517.82):</strong> Special requirements apply to nurse call systems, IT equipment rooms, and other communication systems in health care facilities. The reliability and continuity of these systems are crucial for patient care, so backup power and special protection may be required.</p><h3>Special Compliance Considerations</h3><p><strong>Testing and Documentation (517.30(C)):</strong> Essential electrical systems must be tested upon installation and periodically thereafter. Written records of these tests must be maintained and made available to the authority having jurisdiction (AHJ).</p><p><strong>Coordination with Other Codes:</strong> Health care facilities are also subject to other regulations beyond the NEC, such as:</p><ul><li>NFPA 99 - Health Care Facilities Code: Contains additional details on electrical systems in health care</li><li>NFPA 101 - Life Safety Code: Addresses egress and fire safety in health care facilities</li><li>State health department regulations: May include additional electrical requirements</li><li>Centers for Medicare & Medicaid Services (CMS) requirements: For facilities seeking Medicare/Medicaid reimbursement</li></ul><p><strong>Renovation and Expansion:</strong> When renovating or expanding health care facilities, special care must be taken to maintain compliance with Article 517. This includes ensuring that essential electrical systems are properly expanded, patient care area classifications are correctly updated, and all new work meets current code requirements.</p><h3>Recent Developments and Best Practices</h3><p><strong>Equipment Grounding Bus (517.19(G)):</strong> In critical care spaces, a equipment grounding bus is often installed with connections for all equipment grounding conductors plus a dedicated reference grounding conductor. This helps to minimize voltage differences between equipment and reduces the risk of microshock.</p><p><strong>Surge Protection:</strong> Modern health care facilities often incorporate surge protective devices (SPDs) to protect sensitive electronic medical equipment from damage due to voltage surges. While not specifically required by all sections of Article 517, this protection has become standard practice in many facilities.</p><p><strong>Selective Coordination:</strong> Essential electrical systems in health care facilities must be selectively coordinated, meaning that a fault at any point in the system will be cleared by the nearest protective device, minimizing the extent of any outage.</p><p>Article 517 is one of the most complex and specialized articles in the NEC, reflecting the critical nature of electrical systems in health care facilities. Given the potential consequences of electrical failures or safety issues in these environments, electricians working in health care facilities must thoroughly understand these requirements and stay current as they evolve with each code cycle.</p>"
    }
    
    # Check if article exists
    existing_article = NECArticle.query.filter_by(
        article_number=article_data['article_number']
    ).first()
    
    if existing_article:
        # Update existing article
        existing_article.title = article_data['title']
        existing_article.summary = article_data['summary']
        existing_article.content = article_data['content']
        print(f"Updated Article {article_data['article_number']}: {article_data['title']}")
    else:
        # Create new article
        new_article = NECArticle(
            article_number=article_data['article_number'],
            title=article_data['title'],
            summary=article_data['summary'],
            content=article_data['content']
        )
        db.session.add(new_article)
        print(f"Added Article {article_data['article_number']}: {article_data['title']}")
    
    # Commit changes
    db.session.commit()
    
    return True

def main():
    """Create app context and run the update function."""
    try:
        app = create_app()
        with app.app_context():
            success = update_nec_article()
            if success:
                print(f"NEC article 517 update completed successfully.")
            else:
                print(f"NEC article 517 update failed.")
    except Exception as e:
        print(f"Error: {str(e)}")

if __name__ == "__main__":
    main() 