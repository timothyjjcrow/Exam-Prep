import sys
import os

# Import directly from app
from app import create_app, db
from models import NECArticle

def update_nec_article():
    """Update or add NEC article 690 to the database."""
    # Article data
    article_data = {
        "article_number": "690",
        "title": "Solar Photovoltaic Systems",
        "summary": "Article 690 covers solar photovoltaic systems including the array circuit(s), inverter(s), and controller(s) for such systems. These systems may be interactive with other electrical power sources or stand-alone, with or without electrical energy storage such as batteries.",
        "content": """<h3>Scope and Application</h3><p>Article 690 covers the installation of solar photovoltaic (PV) systems, including arrays, modules, inverters, charge controllers, energy storage systems, and all associated electrical equipment. It applies to both grid-connected and stand-alone PV systems, installed on buildings, ground-mounted, or integrated into building materials.</p><p>The importance of Article 690 has grown as solar PV systems have become increasingly common in both residential and commercial settings. Understanding these requirements is critical for electricians, as improper installation can lead to fire hazards, shock hazards, or system failures.</p><h3>System Components and Definitions</h3><p><strong>PV System (690.2):</strong> The total components and subsystem that combine to convert solar energy into electrical energy suitable for connection to a utilization load.</p><p><strong>PV Module (690.2):</strong> The smallest complete, environmentally protected assembly of interconnected solar cells, capable of generating DC voltage when exposed to light.</p><p><strong>PV Array (690.2):</strong> An assembly of mechanically integrated and electrically interconnected PV modules, and support structure.</p><p><strong>PV Source Circuit (690.2):</strong> The circuit between modules and the common connection point(s) of the DC system, often at the combiner box.</p><p><strong>PV Output Circuit (690.2):</strong> The circuit conductors between the PV source circuit(s) and the inverter or DC utilization equipment.</p><p><strong>Inverter (690.2):</strong> Equipment that converts DC power from the PV array to AC power, either for stand-alone systems or for synchronization with an existing AC system.</p><p><strong>Micro-Inverter (690.2):</strong> A device that converts DC generated by a single module to AC, typically mounted at or near the module.</p><p>Understanding these components and their relationships is fundamental to properly applying Article 690.</p><h3>Labeling and Marking Requirements</h3><p><strong>Marking (690.13(B), 690.31(G), 690.53, 690.54, 690.56):</strong> PV systems must have various labels and markings for safety, including:</p><ul><li>PV disconnect marking (690.13(B)): Must be permanently marked as a "PV SYSTEM DISCONNECT"</li><li>PV power source information (690.53): Voltage (maximum system), current (short-circuit), and maximum rated output</li><li>Interactive system point of interconnection (690.54): Rated AC output current and operating AC voltage</li><li>Identification of power sources (690.56): Buildings with both PV and other power sources must have a permanent plaque indicating the locations of system disconnects</li><li>Wiring methods (690.31(G)): PV system conductors must be labeled to indicate their purpose</li></ul><p>These marking requirements are crucial for emergency responders and maintenance personnel to safely work around PV systems.</p><h3>Circuit Requirements</h3><p><strong>Maximum Voltage (690.7):</strong> PV source and output circuits require calculation of maximum voltage, accounting for the coldest expected ambient temperature. This voltage calculation is critical for selecting properly rated conductors, disconnects, and other equipment.</p><p>For one- and two-family dwellings, PV systems are limited to 600 volts. For other installations, the limit is 1000 volts, with special provisions for large-scale PV systems over 1000 volts in 690 Part IX.</p><p><strong>Circuit Sizing and Current (690.8):</strong> Conductors and overcurrent protection devices must be sized based on:</p><ul><li>The maximum current from the PV source, calculated as 125% of the short-circuit current</li><li>An additional 125% factor for continuous loads (resulting in a total factor of 156% of the short-circuit current)</li></ul><p>This 156% sizing factor ensures that conductors and devices can safely handle the maximum possible current during optimal production conditions.</p><p><strong>Overcurrent Protection (690.9):</strong> Each ungrounded conductor must be protected by an overcurrent device. Exceptions exist for certain PV source circuits where the maximum current from connected parallel source circuits cannot exceed the conductor ampacity.</p><h3>Disconnecting Means</h3><p><strong>Requirement (690.13):</strong> A disconnecting means must be provided to disconnect all ungrounded conductors of a PV system from all other conductors in a building or structure.</p><p><strong>Location (690.13(A)):</strong> The disconnect must be readily accessible and located at a readily accessible location either outside the building or inside nearest the point of entrance of the system conductors.</p><p><strong>Operation (690.13(C)):</strong> The disconnecting means must plainly indicate whether in the open (off) or closed (on) position and must be capable of being locked in the open position.</p><p><strong>Equipment Disconnects (690.15):</strong> Additional disconnecting means are required for equipment such as inverters, batteries, and charge controllers to allow for safe servicing.</p><p>These disconnecting requirements are crucial for emergency responders and maintenance personnel to safely de-energize the system when necessary.</p><h3>Wiring Methods</h3><p><strong>General (690.31):</strong> All PV system wiring must comply with Article 300 and use methods included in Article 310. Special requirements apply for PV wire, which is a single-conductor cable specifically listed for PV applications.</p><p><strong>Wiring on Buildings (690.31(A), (B), and (G)):</strong> When installed on buildings, PV source and output circuits must follow specific requirements:</p><ul><li>Must be secured and supported according to the associated wiring method</li><li>Must be protected from physical damage</li><li>When installed in readily accessible locations, must be contained in raceways</li><li>Must be identified with proper markings</li></ul><p><strong>Single-Conductor Cable (690.31(C)):</strong> Single-conductor cable Type USE-2 and single-conductor cable listed and labeled as PV wire can be used for PV source circuits where exposed to sunlight and weather.</p><p><strong>Direct-Current Photovoltaic Source and Direct-Current Output on or in a Building (690.31(G)):</strong> Where run inside a building, these conductors must be contained in metal raceways, Type MC cable, or metal enclosures from the point of penetration of the building to the first readily accessible disconnecting means.</p><h3>Grounding and Bonding</h3><p><strong>System Grounding (690.41):</strong> PV systems can be installed as:</p><ul><li>Functional grounded systems: One conductor is intentionally grounded (typically negative)</li><li>Reference grounded systems: The DC side is not directly connected to ground but has a reference connection via resistor, relay, or other means</li><li>Ungrounded systems: Neither DC conductor is intentionally connected to ground</li></ul><p>The choice of grounding configuration affects other aspects of the system, including equipment selection, monitoring requirements, and fault detection methods.</p><p><strong>Equipment Grounding (690.43):</strong> All exposed non-current-carrying metal parts of PV module frames, racks, boxes, etc., must be grounded regardless of voltage. Equipment grounding conductors for the PV array and structure must be:</p><ul><li>Contained within the same raceway or cable as the PV circuit conductors when those conductors leave the vicinity of the PV array, or</li><li>Run with the PV source and output circuit conductors when those conductors are routed separately from other conductors</li></ul><p><strong>Size of Equipment Grounding Conductor (690.45):</strong> For PV source and output circuits, the equipment grounding conductors shall not be smaller than the required size of the circuit conductors, with some minimum size requirements based on overcurrent device ratings.</p><h3>Interconnection with Other Sources</h3><p><strong>Interactive Systems (690.60 through 690.65):</strong> PV systems connected to utility services or other power production sources must:</p><ul><li>Have an interactive inverter listed for utility interconnection (UL 1741)</li><li>Have proper connection configuration to avoid backfeeding unintentionally</li><li>Include a means to automatically disconnect from the utility when grid power is lost (anti-islanding protection)</li><li>Meet the requirements of Article 705 (Interconnected Electric Power Production Sources)</li></ul><p><strong>Point of Connection (705.12):</strong> Interactive PV systems can connect to the supply side or load side of the service disconnecting means, with specific requirements for each method:</p><ul><li>Supply side: Must comply with service equipment requirements, including disconnecting means and overcurrent protection</li><li>Load side: Total rating of all overcurrent devices connected to a busbar or conductor cannot exceed 120% of the rating of the busbar or conductor (known as the "120% rule")</li></ul><h3>Rapid Shutdown of PV Systems on Buildings</h3><p><strong>Requirements (690.12):</strong> PV systems installed on buildings must include a rapid shutdown function to reduce shock hazard for emergency responders. When initiated, this function must:</p><ul><li>Reduce voltage of conductors more than 30 cm (1 ft) from the array to 30V or less within 30 seconds</li><li>Reduce voltage within the array boundary to 80V or less within 30 seconds</li></ul><p><strong>Initiation Device (690.12(C)):</strong> The rapid shutdown initiator must be located near the main service disconnecting means and be clearly labeled as "RAPID SHUTDOWN SYSTEM FOR SOLAR PV SYSTEM".</p><p><strong>Equipment (690.12(D)):</strong> Equipment that performs the rapid shutdown function must be listed and identified for this purpose.</p><p>The rapid shutdown requirements were introduced to address concerns from firefighters about shock hazards when responding to fires on buildings with PV systems.</p><h3>Storage Batteries</h3><p><strong>Requirements (690.71):</strong> For PV systems with storage batteries, many requirements apply, including:</p><ul><li>Live parts of battery systems must be guarded to prevent accidental contact</li><li>Battery enclosures must be ventilated to prevent gas accumulation</li><li>Specific disconnecting and overcurrent protection is required</li><li>Batteries must be properly secured to prevent movement</li></ul><p>Additionally, Article 706 (Energy Storage Systems) contains extensive requirements for battery systems that may be part of a PV installation.</p><h3>Special Provisions for Large-Scale PV Systems</h3><p><strong>Part IX (690.80 through 690.85):</strong> For PV systems over 1000V, special requirements apply, including:</p><ul><li>Equipment must be listed for the voltage</li><li>Circuit conductors must be installed in accordance with Article 300, Parts I and II</li><li>Specific provisions apply for circuit routing, disconnecting means, and overcurrent protection</li></ul><p>These larger systems typically appear in utility-scale installations and require specialized equipment and engineering.</p><h3>Common Compliance Issues</h3><p><strong>Improper Conductor Sizing:</strong> Failing to apply the 156% factor for circuit sizing, leading to conductors that may overheat during maximum production.</p><p><strong>Missing Labels:</strong> Inadequate system labeling, particularly for disconnects and rapid shutdown systems, creating risks for emergency responders.</p><p><strong>Improper Grounding:</strong> Insufficient equipment grounding or incorrect system grounding configuration can lead to shock hazards or system malfunctions.</p><p><strong>Inadequate Rapid Shutdown:</strong> Newer PV installations require compliant rapid shutdown systems, and older systems may need upgrades to meet current requirements.</p><p><strong>Incorrect Interconnection:</strong> Improperly connecting to the utility grid, especially exceeding the 120% rule for load-side connections, can cause overheating and potential fire hazards.</p><p>Understanding and properly implementing Article 690 is essential for safe PV system installations. The complexity of these systems and their potential hazards make this one of the most detailed articles in the NEC, with requirements that continue to evolve as PV technology becomes more prevalent.</p>"""
    }
    
    # Check if article exists
    existing_article = NECArticle.query.filter_by(
        article_number=article_data['article_number']
    ).first()
    
    if existing_article:
        # Update existing article
        existing_article.title = article_data['title']
        existing_article.summary = article_data['summary']
        existing_article.content = article_data['content']
        print(f"Updated Article {article_data['article_number']}: {article_data['title']}")
    else:
        # Create new article
        new_article = NECArticle(
            article_number=article_data['article_number'],
            title=article_data['title'],
            summary=article_data['summary'],
            content=article_data['content']
        )
        db.session.add(new_article)
        print(f"Added Article {article_data['article_number']}: {article_data['title']}")
    
    # Commit changes
    db.session.commit()
    
    return True

def main():
    """Create app context and run the update function."""
    try:
        app = create_app()
        with app.app_context():
            success = update_nec_article()
            if success:
                print(f"NEC article 690 update completed successfully.")
            else:
                print(f"NEC article 690 update failed.")
    except Exception as e:
        print(f"Error: {str(e)}")

if __name__ == "__main__":
    main() 